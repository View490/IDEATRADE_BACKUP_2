<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <title>Line Charts</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <h1 id="error-message"></h1>
    <script type="text/javascript" src="{{ url_for('static', filename='hammer.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>



<body>

    <input type="text" id="symbolInput" placeholder="Enter symbol" value='CV'>
    <input type="text" id="startDate" placeholder="Select start date">
    <input type="text" id="endDate" placeholder="Select end date">
    <button onclick="updateChartData()">Update Chart</button>
    <button onclick="alldate_show()">all date</button>

    <div class="container">
        <div class="table-container">
            
            <div class="row">
                <div>
                  <table>
                    <tr>
                      <th>SYMBOL</th>
                      <th>COUNT</th>
                    </tr>
                 
                    <tr>
                      <td>sel_string</td>
                      <td>sel_number</td>
                    </tr>
                    <tr>
                      <td>Adam</td>
                      <td>67</td>
                    </tr>
                  </table>
                </div>
                <div class="column" id="table_counts" style="overflow-y: scroll;">
                    <table id="securities_table">
                        <tr>
                            <th><button id="symbols">Symbols</button></th>
                            <th ><button id="counts">COUNTS</button></th>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <div id="chartContainer" class="chart-container">
            <canvas id="line-chart"></canvas>
        </div>
    </div>

    <script type="text/javascript" src="{{ url_for('static', filename='df_securities.js') }}"></script>
    <script>
        // Function to populate the table with data
        function populateTable(startDate, endDate) {
            // Get references to the input fields
            var startDateInput = document.getElementById("startDate");
            var endDateInput = document.getElementById("endDate");

            // Log the real start and end dates
            console.log("REAL Start Date:", startDate);
            console.log("REAL End Date:", endDate);

            // Get the index of start and end dates in the labels
            var labels = df_securities.labels;
            var startIndex = labels.indexOf(startDate);
            var endIndex = labels.indexOf(endDate);

            // Check if the start or end date is not found in labels
            if (startIndex === -1 || endIndex === -1) {
                console.log("Start date or end date not found in labels.");
                return; // Exit the function if dates are not found
            }

            // Object to store symbol counts
            var countMap = {};

            // Iterate over the data and count non-zero occurrences for each symbol
            for (var key in df_securities) {
                if (key !== "labels" && df_securities.hasOwnProperty(key)) {
                    var count = 0;
                    for (var i = startIndex; i >= endIndex; i--) {
                        if (parseFloat(df_securities[key][i]) > 0) {
                            count++;
                        }
                    }
                    countMap[key] = count;
                }
            }

            // Clear previous table data
            var table = document.getElementById("securities_table");
            var tbody = table.querySelector("tbody");
            tbody.innerHTML = "";

            // Add header row if it doesn't exist
            if (!table.tHead) {
                var headerRow = table.createTHead().insertRow(0);
                var symbolsHeader = headerRow.insertCell(0);
                var countsHeader = headerRow.insertCell(1);
                symbolsHeader.textContent = "SYMBOLS";
                countsHeader.textContent = "COUNTS";
                headerRow.style.fontWeight = "bold"; // Bold font for header row

                // Add event listener to the "COUNTS" header to enable sorting
                countsHeader.innerHTML = '<a href="#" id="countsHeader">COUNTS</a>';
                document.getElementById("countsHeader").addEventListener("click", function(event) {
                    event.preventDefault(); // Prevent default anchor behavior
                    sort_value(sort_index=1);
                });
                symbolsHeader.innerHTML = '<a href="#" id="symbolsHeader">SYMBOLS</a>';
                document.getElementById("symbolsHeader").addEventListener("click", function(event) {
                    event.preventDefault(); // Prevent default anchor behavior
                    sort_value(sort_index=0);
                });
            }

            // Populate the table with symbol counts
            for (var symbol in countMap) {
                var row = tbody.insertRow();
                var symbolCell = row.insertCell(0);
                var countCell = row.insertCell(1);
                symbolCell.textContent = symbol;
                countCell.textContent = countMap[symbol];
            }
        }

        direction = "asc"; // Default sorting direction
        // Function to sort the table by counts
        function sort_value(sort_index) {
            var table, rows, switching, i, x, y, shouldSwitch;
            table = document.getElementById("securities_table");
            switching = true;
            console.log('sort index:',sort_index)

            /*Make a loop that will continue until
            no switching has been done:*/
            while (switching) {
                //start by saying: no switching is done:
                switching = false;
                rows = table.rows;
                /*Loop through all table rows (except the
                first, which contains table headers):*/
                for (i = 1; i < (rows.length - 1); i++) {
                    //start by saying there should be no switching:
                    shouldSwitch = false;
                    /*Get the two elements you want to compare,
                    one from current row and one from the next:*/
                    x = rows[i].getElementsByTagName("TD")[sort_index]; // Counts column
                    y = rows[i + 1].getElementsByTagName("TD")[sort_index]; // Counts column
                    //check if the two rows should switch place:
                    if (
                            (direction=="asc" && sort_index==1 && parseInt(x.innerHTML) < parseInt(y.innerHTML))
                                ||
                            (direction=="desc" && sort_index==1 && parseInt(x.innerHTML) > parseInt(y.innerHTML))
                                ||
                            (direction=="asc" && sort_index==0 && x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase())
                                ||
                            (direction=="desc" && sort_index==0 && x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase())
                        ) {
                        //if so, mark as a switch and break the loop:
                        shouldSwitch = true;
                        break;
                    }
                }
                if (shouldSwitch) {
                    /*If a switch has been marked, make the switch
                    and mark that a switch has been done:*/
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                }
                else {
                    if (direction==="asc"){
                        direction="desc";
                    }
                    else if (direction==="desc"){
                        direction="asc";
                    }
                }
            }
        }

        // Add event listeners to the input fields
        var startDateInput = document.getElementById("startDate");
        var endDateInput = document.getElementById("endDate");
        startDateInput.addEventListener('change', function() {
            var startDate = startDateInput.value;
            var endDate = endDateInput.value;
            populateTable(startDate, endDate);
        });
        endDateInput.addEventListener('change', function() {
            var startDate = startDateInput.value;
            var endDate = endDateInput.value;
            populateTable(startDate, endDate);
        });

        // Initial population of the table
        populateTable(startDateInput.value, endDateInput.value);

    </script>

    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='df_securities.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='closing_prices.js') }}"></script>

</body>
</html>
